<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>GitHub 이미지 마커(둥글고 작은 아이콘)</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { width:100%; height:100%; }
  #distance {
    position:absolute;
    top:10px; left:10px;
    background:rgba(0,0,0,.6);
    color:#fff;
    padding:5px 10px;
    border-radius:4px;
    font-size:14px;
  }

  /* 마커용 컨테이너 */
  .marker-wrapper {
    width:25px;          /* 원하는 크기 */
    height:25px;
    border-radius:50%;   /* 둥글게 */
    overflow:hidden;     /* 이미지가 넘치면 잘라내기 */
    box-shadow:0 2px 6px rgba(0,0,0,.3); /* 그림자 (옵션) */
  }
  .marker-wrapper img {
    width:100%; height:100%;
    object-fit:cover;   /* 비율을 유지하며 꽉 채우기 */
  }
</style>
</head>
<body>

<div id="map"></div>
<div id="distance">이동 거리: 0.00 km</div>

<script>
  // ───── Mapbox 설정 ────────────────────────────────
  mapboxgl.accessToken = 'pk.eyJ1IjoiaG9vbmNvbSIsImEiOiJjbWNjM3R4enUwM3pnMmlxMWJvZTVrMWIzIn0.h_-BNK4FuriEfFWXvE1pmw';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [126.9780, 37.5665],
    zoom: 16
  });
  map.addControl(new mapboxgl.NavigationControl());

  // ───── 거리 계산 헬퍼 함수 ────────────────────────────
  const toRad = d => d * Math.PI / 180;
  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;                     // km
    const a =
      Math.sin(toRad(lat2-lat1)/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
      Math.sin(toRad(lon2-lon1)/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // ───── 전역 변수 ───────────────────────────────
  let marker = null;            // 한 번만 생성되는 마커
  let prevLat, prevLng;
  let totalDist = 0;

  // ───── GitHub 이미지 URL (Raw 형태) ────────────────────────
  const GITHUB_IMG_URL =
    'https://raw.githubusercontent.com/ljw2455qq/realtimeirl/main/profile.png';

  // ───── 커스텀 이미지 마커 생성 함수 ────────────────────────
  function createCustomMarker(lat, lng) {
    // wrapper(컨테이너) + img 태그를 별도로 만들어줍니다.
    const el = document.createElement('div');
    el.className = 'marker-wrapper';

    const img = document.createElement('img');
    img.src = GITHUB_IMG_URL;
    el.appendChild(img);

    return new mapboxgl.Marker(el).setLngLat([lng, lat]).addTo(map);
  }

  // ───── 위치 업데이트 함수 (한 번만 마커 생성) ────────────────
  function updateLocation(lat, lng) {
    if (!marker) {            // 최초 한 번만 마커 생성
      marker = createCustomMarker(lat, lng);
    } else {
      marker.setLngLat([lng, lat]);   // 이후에는 위치만 바꿈
    }

    map.setCenter([lng, lat]);

    if (prevLat != null && prevLng != null) {
      const d = haversine(prevLat, prevLng, lat, lng);
      totalDist += d;
      document.getElementById('distance').innerText =
        `이동 거리: ${totalDist.toFixed(2)} km`;
    }
    prevLat = lat;  prevLng = lng;
  }

  // ───── GPS 감시 시작 ─────────────────────────
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      pos => updateLocation(pos.coords.latitude, pos.coords.longitude),
      err => { console.error(err); alert('GPS를 불러올 수 없습니다.'); },
      { enableHighAccuracy:true, maximumAge:0 }
    );
  } else {
    alert('이 브라우저는 GPS를 지원하지 않습니다.');
  }

</script>
</body>
</html>
