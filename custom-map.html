<!DOCTYPE html>
<html>
  <head>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
    <script src="https://mapbox.github.io/mapbox-gl-language/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@rtirl/api@latest/lib/index.min.js"></script>
    <script src="./indicator.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      /* 마커 div를 사용하지 않으므로, 기존 스타일은 필요 없습니다. */
    </style>
  </head>
  <body>
    <div style="position: relative; width: 100%; height: 100%;">
      <div id="map" style="width: 300px; height: 250px"></div>
    </div>
    <script>
      var params = new URLSearchParams(window.location.search);
      
      if(params.get("fullscreen")) {
        document.documentElement.setAttribute('style', 'margin: 0; padding: 0; width: 100%; height: 100%;');
        document.body.setAttribute('style', 'margin: 0; padding: 0; width: 100%; height: 100%;');
        document.getElementById('map').setAttribute('style', 'height: 100%; width: 100%;');
      }

      mapboxgl.accessToken = params.get("access_token");
      var zoom = params.get("zoom");
      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/" + params.get("style"),
        interactive: false,
        attributionControl: false,
        zoom: zoom ? Number(zoom) : 13,
      });
      map.addControl(
        new MapboxLanguage({ defaultLanguage: params.get("lang") || "en" })
      );

      var mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });

      // 지도가 로드되면 마커 이미지와 레이어를 추가합니다.
      map.on('load', function () {
        // 1. 마커로 사용할 이미지 로드
        map.loadImage(
          'https://github.com/ljw2455qq/realtimeirl/blob/main/profile.png',
          function (error, image) {
            if (error) {
              console.error('마커 이미지 로드 실패:', error);
              return;
            }
            // 로드된 이미지를 'custom-marker'라는 이름으로 추가
            map.addImage('custom-marker', image);
            
            // 2. 마커를 표시할 'point' 데이터 소스 추가
            map.addSource('points', {
              'type': 'geojson',
              'data': {
                'type': 'FeatureCollection',
                'features': [] // 초기에는 마커가 없으므로 빈 배열로 시작
              }
            });
            
            // 3. 'custom-marker' 이미지를 사용하는 '레이어' 추가
            map.addLayer({
              'id': 'points',
              'type': 'symbol',
              'source': 'points',
              'layout': {
                'icon-image': 'custom-marker',
                'icon-size': 0.5, // 이미지 크기 조절 (1이 기본값)
                'icon-allow-overlap': true,
                'icon-anchor': 'bottom' // 마커의 기준점을 이미지 하단으로 설정
              }
            });
        }
      );
    });

    // RealtimeIRL 위치 수신 리스너
    const pullKey = new URLSearchParams(window.location.search).get("key");
    RealtimeIRL.forPullKey(pullKey).addLocationListener(
      function (location) {
        // 지도 중심 이동
        map.panTo([location.longitude, location.latitude], {
          duration: 1500,
          easing: (x) => x,
        });
        
        // 'points' 데이터 소스를 업데이트하여 마커 위치 변경
        if (map.getSource('points')) {
          map.getSource('points').setData({
            'type': 'FeatureCollection',
            'features': [{
              'type': 'Feature',
              'geometry': {
                'type': 'Point',
                'coordinates': [location.longitude, location.latitude]
              }
            }]
          });
        }
      }
    );
    </script>
  </body>
</html>
