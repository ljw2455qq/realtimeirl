<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Distance + GPS Map Overlay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- RTIRL OBS API -->
  <script src="https://cdn.jsdelivr.net/npm/@rtirl/api@latest/lib/index.min.js"></script>

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background: transparent; }
    #map { position:absolute; inset:0; z-index:0; pointer-events:none; }
    #text { position:absolute; top:10px; left:10px; 
            background:rgba(0,0,0,0.5); color:#fff; padding:10px; 
            border-radius:8px; font-family:sans-serif; z-index:1; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="text">Waiting for stream to start...</div>

<script>
  const MAPBOX_TOKEN = "pk.eyJ1IjoiaG9vbmNvbSIsImEiOiJjbWNjM3R4enUwM3pnMmlxMWJvZTVrMWIzIn0.h_-BNK4FuriEfFWXvE1pmw";
  mapboxgl.accessToken = pk.eyJ1IjoiaG9vbmNvbSIsImEiOiJjbWNjM3R4enUwM3pnMmlxMWJvZTVrMWIzIn0.h_-BNK4FuriEfFWXvE1pmw;

  // 초기 지도
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [127.0, 37.5], // 초기 좌표
    zoom: 13,
    interactive: false
  });

  // 마커 초기화
  let marker = null;

  // 거리 계산 변수
  let lastLat = null, lastLon = null;
  let totalKm = 0;

  function haversineKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = Math.PI / 180;
    const dLat = (lat2 - lat1) * toRad;
    const dLon = (lon2 - lon1) * toRad;
    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1*toRad) * Math.cos(lat2*toRad) *
              Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // RTIRL API 연결
  const api = new rtirl.Api();
  api.on('location', (loc) => {
    const { latitude, longitude } = loc.coords;
    
    // 거리 계산
    if (lastLat !== null && lastLon !== null) {
      totalKm += haversineKm(lastLat, lastLon, latitude, longitude);
    }
    lastLat = latitude;
    lastLon = longitude;

    // 거리 표시 업데이트
    document.getElementById("text").textContent = 
      `이동 거리: ${totalKm.toFixed(2)} km`;

    // 지도/마커 갱신
    if (!marker) {
      marker = new mapboxgl.Marker({ color: "#00ff88" })
        .setLngLat([longitude, latitude])
        .addTo(map);
    } else {
      marker.setLngLat([longitude, latitude]);
    }
    map.setCenter([longitude, latitude]);
  });

  api.on('connected', () => {
    console.log("RTIRL 연결됨");
  });
  api.connect();
</script>
</body>
</html>
