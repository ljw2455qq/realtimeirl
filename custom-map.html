<!DOCTYPE html>
<html>
  <head>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
    <script src="https://mapbox.github.io/mapbox-gl-language/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@rtirl/api@latest/lib/index.min.js"></script>
    <script src="./indicator.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      /* 마커 div를 사용하지 않으므로, 기존 스타일은 필요 없습니다. */
    </style>
  </head>
  <body>
    <div style="position: relative; width: 100%; height: 100%;">
      <div id="map" style="width: 300px; height: 250px"></div>
    </div>
    <script>
      var params = new URLSearchParams(window.location.search);
      
      if(params.get("fullscreen")) {
        document.documentElement.setAttribute('style', 'margin: 0; padding: 0; width: 100%; height: 100%;');
        document.body.setAttribute('style', 'margin: 0; padding: 0; width: 100%; height: 100%;');
        document.getElementById('map').setAttribute('style', 'height: 100%; width: 100%;');
      }

      // Mapbox access token을 직접 입력하세요
      mapboxgl.accessToken = 'pk.eyJ1Ijoia2V2bW8zMTQiLCJhIjoiY2w0MW1qaTh3MG80dzNjcXRndmJ0a2JieiJ9.Y_xABmAqvD-qZeed8MabxQ';

      var zoom = params.get("zoom");
      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/" + params.get("style"),
        interactive: false,
        attributionControl: false,
        zoom: zoom ? Number(zoom) : 13,
      });
      map.addControl(
        new MapboxLanguage({ defaultLanguage: params.get("lang") || "en" })
      );

      var mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });

      // 지도가 로드되면 마커 이미지와 레이어를 추가합니다.
      map.on('load', function () {
        // 1. 마커로 사용할 이미지 로드 (원본(raw) 이미지 URL 사용)
        map.loadImage(
          'https://raw.githubusercontent.com/ljw2455qq/realtimeirl/main/profile.png',
          function (error, image) {
            if (error) {
              console.error('마커 이미지 로드 실패:', error);
              return;
            }
            map.addImage('custom-marker', image);
            
            // 2. 마커를 표시할 'point' 데이터 소스 추가
            map.addSource('points', {
              'type': 'geojson',
              'data': {
                'type': 'FeatureCollection',
                'features': []
              }
            });
            
            // 3. 'custom-marker' 이미지를 사용하는 '레이어' 추가
            map.addLayer({
              'id': 'points',
              'type': 'symbol',
              'source': 'points',
              'layout': {
                'icon-image': 'custom-marker',
                'icon-size': 0.5,
                'icon-anchor': 'bottom'
              }
            });
          }
        );
      });

      // RealtimeIRL Pull Key를 직접 입력하세요
      const pullKey = 'zeoeyze9htbyx455';
      RealtimeIRL.forPullKey(pullKey).addLocationListener(
        function (location) {
          map.panTo([location.longitude, location.latitude], {
            duration: 1500,
            easing: (x) => x,
          });
        
          if (map.getSource('points')) {
            map.getSource('points').setData({
              'type': 'FeatureCollection',
              'features': [{
                'type': 'Feature',
                'geometry': {
                  'type': 'Point',
                  'coordinates': [location.longitude, location.latitude]
                }
              }]
            });
          }
        }
      );
    </script>
  </body>
</html>
