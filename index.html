<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>hooni 스타일 GPS 오버레이</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: sans-serif;
      overflow: hidden;
    }

    .map-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 400px; /* 가로 너비 조절 */
      /* box-shadow: 0 0 10px rgba(0,0,0,0.5); */
    }

    #map {
      width: 100%;
      height: 200px; /* 세로 높이 조절 */
    }

    .overlay-info {
      width: 100%;
      box-sizing: border-box;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .overlay-info img.logo {
      height: 20px;
      vertical-align: middle;
    }
    .marker-img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 5px #000;
    }
  </style>
</head>
<body>
  <div class="map-container">
    <div id="map"></div>
    <div class="overlay-info">
      <span id="distance">주행 거리: 0.00km</span>
      <span id="earnings">수익: 0원</span>
      <span id="likes">❤️ 0</span>
      <img class="logo" src="https://yourcdn.com/chzzk.png" />
      <img class="logo" src="https://yourcdn.com/soop.png" />
      <img class="logo" src="https://yourcdn.com/twitch.svg" />
      <img class="logo" src="https://yourcdn.com/youtube.svg" />
    </div>
  </div>

  <script>
    // Mapbox 초기화
    mapboxgl.accessToken = 'pk.eyJ1IjoiaG9vbmNvbSIsImEiOiJjbWNjM3R4enUwM3pnMmlxMWJvZTVrMWIzIn0.h_-BNK4FuriEfFWXvE1pmw';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [126.8540, 35.1291],
      zoom: 16,
      interactive: true
    });

    map.addControl(new mapboxgl.NavigationControl());

    const el = document.createElement('img');
    el.src = 'https://ljw2455qq.github.io/rider-324/profile.png';
    el.className = 'marker-img';
    const marker = new mapboxgl.Marker(el).setLngLat([126.8540, 35.1291]).addTo(map);

    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyA5hMmN9QFgdFtaA5gicS_pj-blu_jJdvE",
      authDomain: "rider-bf48b.firebaseapp.com",
      databaseURL: "https://rider-bf48b-default-rtdb.firebaseio.com",
      projectId: "rider-bf48b",
      storageBucket: "rider-bf48b.appspot.com",
      messagingSenderId: "1026929653322",
      appId: "1:1026929653322:web:b90541cccba5b4186198b3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let prev = null;
    let total = 0;

    function deg2rad(d) { return d * (Math.PI / 180); }
    function getDistance(a, b) {
      const R = 6371;
      const dLat = deg2rad(b.lat - a.lat);
      const dLon = deg2rad(b.lng - a.lng);
      const c = Math.sin(dLat / 2) ** 2 +
                Math.cos(deg2rad(a.lat)) * Math.cos(deg2rad(b.lat)) *
                Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(c), Math.sqrt(1 - c));
    }

    // Geolocation API로 핸드폰 위치 추적
    function startGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            const coords = { lat: latitude, lng: longitude };

            // 마커와 지도 중심을 업데이트
            marker.setLngLat([longitude, latitude]);
            map.setCenter([longitude, latitude]);

            // Firebase에 위치 저장
            db.ref('location').set({
              lat: latitude,
              lng: longitude
            });

            // 주행 거리 계산
            if (prev) {
              const dist = getDistance(prev, coords);
              if (dist < 1) total += dist;
              document.getElementById('distance').innerText = `주행 거리: ${total.toFixed(2)}km`;
              document.getElementById('earnings').innerText = `수익: ${(total * 900).toLocaleString()}원`;
            }
            prev = coords;
          },
          (error) => {
            console.error('Geolocation 오류:', error.message);
            alert('위치 정보를 가져올 수 없습니다. GPS를 활성화하거나 권한을 허용하세요.');
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      } else {
        alert('이 브라우저는 Geolocation을 지원하지 않습니다.');
      }
    }

    // Firebase에서 좋아요 수 업데이트
    db.ref('stats/heart').on('value', snap => {
      const h = snap.val();
      if (h !== null) {
        document.getElementById('likes').innerText = `❤️ ${h}`;
      }
    });

    // 페이지 로드 시 Geolocation 시작
    window.onload = startGeolocation;
  </script>
</body>
</html>
